<!doctype html>
<!--
IndexedDB-Utils - A browser extension to simplify indexedDB management tasks

Copyright (C) 2025 Erik Swanson

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<html>
  <style>
    table {
      table-layout: fixed;
      width: 80%;
      min-width: 1000px;
      margin: 0 auto;
      border-collapse: collapse;
      border: 1px solid black;
    }
    td {
      border: 1px solid black;
    }
  </style>
  <body>
    <h1>IndexedDbTest</h1>
    <table>
      <thead>
        <tr>
          <td>Database</td>
          <td>Version</td>
          <td>Object Store</td>
          <td>Indexes</td>
          <td>Record Count</td>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <script>
      window.onload = () => {

        /* DATABASE 1 */
        const dbOpenReq = window.indexedDB.open('browser-extension-test', 2);
        let db;

        dbOpenReq.onerror = (event) => {
          console.log("Error opening database");
          console.log(event);
        }

        dbOpenReq.onsuccess = async (event) => {
          console.log("Successfully opened database");

          db = dbOpenReq.result;

          dbSummary = await idbSummary(db);
          console.log(dbSummary);
          tablify(dbSummary);
        }

        dbOpenReq.onupgradeneeded = (event) => {
          console.log("In onupgradeneeded");
          const db = dbOpenReq.result;

          versionUpgrades(event, {
            1: (db) => {
              const store = db.createObjectStore("books", {keyPath: "isbn"});
              const titleIndex = store.createIndex("by_title", "title", {unique: true});
              const authorIndex = store.createIndex("by_author", "author");

              store.put({
                title: "A Fire Upon the Deep", author: "Vernor Vinge", isbn: "0312851820"
              });
              store.put({
                title: "The Dispossessed", author: "Ursula Le Guin", isbn: "0060125632"
              });
              store.put({
                title: "Ancillary Justice", author: "Ann Leckie", isbn: "9780316246620"
              });
            },
            2: (db) => {
              const store = db.createObjectStore("dogs", {keyPath: "id", autoIncrement: true});
              const breedIndex = store.createIndex("by_breed", "breed", {unique: true});
              const countryIndex = store.createIndex("by_country", "country");

              store.put({ breed: "Sheepdog", country: "England" });
              store.put({ breed: "Poodle", country: "France" });
              store.put({ breed: "Sheepadoodle", country: "Ohio" });
            }
          })

        }

        /* DATABASE 2 */
        const dbOpenReq2 = window.indexedDB.open("second-extension-test");
        let db2;

        dbOpenReq2.onerror = (event) => {
          console.log("Error opening database 2");
          console.log(event);
        }

        dbOpenReq2.onsuccess = async (event) => {
          console.log("Successfully opened database 2");
          db2 = dbOpenReq2.result;

          let summary = await idbSummary(db2);
          tablify(summary);
        }

        dbOpenReq2.onupgradeneeded = (event) => {
          console.log("In db2 onupgradeneeded");
          const db = dbOpenReq2.result;
          console.log(db);

          versionUpgrades(event, {
            0: (db) => {},
            1: (db) => {
              const store = db.createObjectStore("cities", {keyPath: "id", autoIncrement: true});
              const nameIndex = store.createIndex("by_name", "name");
              const countryIndex = store.createIndex("by_country", "country");
              const popIndex = store.createIndex("by_population", "population");

              store.put({name: "Pittsburgh", country: "USA", population: 1745000});
              store.put({name: "Chengdu", country: "China", population: 8040000});
              store.put({name: "Split", country: "Croatia", population: 149800});
            }
          });
        }

        /* DISPLAY FUNCTIONS */

        async function idbSummary(dbHandle) {
          const summary = [];
          const dbName = dbHandle.name;
          const dbVersion = dbHandle.version;
          for (const storeName of dbHandle.objectStoreNames) {
            const t = dbHandle.transaction(storeName, "readonly");
            const store = t.objectStore(storeName);
            const count = await idbResponse(store.count(), req => req.result);

            summary.push({
              name: dbName,
              version: dbVersion,
              store: storeName,
              indexes: [...store.indexNames].join(", "),
              count: count,
            });
          }
          return summary;
        }

        async function tablify(summary) {
          const tbody = document.querySelector("tbody");
          for (entry of summary) {
            const row = [
              entry.name, entry.version, entry.store, entry.indexes, entry.count
            ];
            const tr = document.createElement("tr");
            for (const item of row) {
              const td = document.createElement("td");
              td.appendChild(document.createTextNode(item));
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }
        }

        /* IDB UTILITY FUNCTIONS */

        function idbResponse(request, onSuccess) {
          return new Promise((resolve, reject) => {
            request.onerror = (ev) => {
              reject(`IDBRequest Error: ${ev.target.error}`);
            }
            request.onsuccess = (ev) => {
              resolve(onSuccess(ev.target));
            }
          });
        }

        function versionUpgrades(event, upgradeFns) {
          const db = event.target.result;
          const current = event.oldVersion;
          const requested = event.newVersion;

          const versions = Object.keys(upgradeFns).map(Number).sort();
          if (!versions.includes(current)) {
            throw new Error(`upgradeFns missing current version: ${current}`);
          }
          if (!versions.includes(requested)) {
            throw new Error(`upgradeFns missing requested version: ${requested}`);
          }
          const versionsSlice = versions.slice(versions.indexOf(current) + 1);
          for (v of versionsSlice) {
            upgradeFns[v](db);
            console.log(`Successfully upgraded ${db.name} to version: ${v}`);
          }
        }
      }
    </script>
  </body>
</html>
