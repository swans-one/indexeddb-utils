<!doctype html>
<html>
  <style>
    table {
      table-layout: fixed;
      width: 80%;
      min-width: 1000px;
      margin: 0 auto;
      border-collapse: collapse;
      border: 1px solid black;
    }
    td {
      border: 1px solid black;
    }
  </style>
  <body>
    <h1>IndexedDbTest</h1>
    <table>
      <thead>
        <tr>
          <td>Database</td>
          <td>Version</td>
          <td>Object Store</td>
          <td>Indexes</td>
          <td>Count</td>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <script>
      window.onload = () => {
        const dbOpenReq = window.indexedDB.open('browser-extension-test');
        let db;

        dbOpenReq.onerror = (event) => {
          console.log("Error opening database");
          console.log(event);
        }

        dbOpenReq.onupgradeneeded = (event) => {
          console.log("In onupgradeneeded")

          const db = dbOpenReq.result;

          const store = db.createObjectStore("books", {keyPath: "isbn"});
          const titleIndex = store.createIndex("by_title", "title", {unique: true});
          const authorIndex = store.createIndex("by_author", "author");

          store.put({
            title: "A Fire Upon the Deep", author: "Vernor Vinge", isbn: "0312851820"
          });
          store.put({
            title: "The Dispossessed", author: "Ursula Le Guin", isbn: "0060125632"
          });
          store.put({
            title: "Ancillary Justice", author: "Ann Leckie", isbn: "9780316246620"
          });
        }

        dbOpenReq.onsuccess = async (event) => {
          console.log("Successfully opened database");

          db = dbOpenReq.result;

          dbSummary = await idbSummary(db);
          console.log(dbSummary);
          tablify(dbSummary);
        }

        async function idbSummary(dbHandle) {
          const summary = [];
          const dbName = dbHandle.name;
          const dbVersion = dbHandle.version;
          for (const storeName of dbHandle.objectStoreNames) {
            const t = db.transaction(storeName, "readonly");
            const store = t.objectStore(storeName);
            const count = await idbResponse(store.count(), req => req.result);

            summary.push({
              name: dbName,
              version: dbVersion,
              store: storeName,
              indexes: [...store.indexNames].join(", "),
              count: count,
            });
          }
          return summary;
        }

        async function tablify(summary) {
          const tbody = document.querySelector("tbody");
          for (entry of summary) {
            const row = [
              entry.name, entry.version, entry.store, entry.indexes, entry.count
            ];
            const tr = document.createElement("tr");
            for (const item of row) {
              const td = document.createElement("td");
              td.appendChild(document.createTextNode(item));
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }
        }


        function idbResponse(request, onSuccess) {
          return new Promise((resolve, reject) => {
            request.onerror = (ev) => {
              reject(`IDBRequest Error: ${ev.target.error}`);
            }
            request.onsuccess = (ev) => {
              resolve(onSuccess(ev.target));
            }
          });
        }
      }
    </script>
  </body>
</html>
